name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '18.x'

jobs:
  # Job 1: Security Audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Run security audit
        run: npm audit --audit-level=high
        continue-on-error: true

  # Job 2: Automated Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test -- --coverage --maxWorkers=2 --forceExit
        env:
          NODE_ENV: test
          MONGODB_URI: ${{ secrets.TEST_MONGODB_URI }}
          JWT_SECRET: test-jwt-secret-for-ci-only
          JWT_EXPIRE: 7d
          PORT: 5000
          EMAIL_SERVICE: gmail
          EMAIL_USER: test@example.com
          EMAIL_PASS: test-password
          CLOUDINARY_CLOUD_NAME: test-cloud
          CLOUDINARY_API_KEY: test-key
          CLOUDINARY_API_SECRET: test-secret
          GOOGLE_CLIENT_ID: test-client-id
          GOOGLE_CLIENT_SECRET: test-client-secret
          FRONTEND_URL: http://localhost:8080
          ADMIN_URL: http://localhost:3001
          CALLBACK_URL: http://localhost:5000/api/auth/google/callback
          ENABLE_SECURE_COOKIES: false
          UV_THREADPOOL_SIZE: 128
          SKIP_SESSION: false
          DISABLE_RATE_LIMIT: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-${{ matrix.node-version }}
        continue-on-error: true

      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-node-${{ matrix.node-version }}
          path: coverage/
          retention-days: 7

  # Job 3: Build Verification
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [test, security]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify project structure
        run: |
          echo "Verifying project structure..."
          test -f package.json || exit 1
          test -f server.js || exit 1
          test -f jest.config.js || exit 1
          test -d models || exit 1
          test -d routes || exit 1
          test -d controllers || exit 1
          test -d config || exit 1
          test -d middleware || exit 1
          test -d utils || exit 1
          echo "âœ… Build verification passed!"

  # Job 4: Deploy to Production (Render)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://nairobi-verified-zkl3.onrender.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify deployment start
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ STARTING PRODUCTION DEPLOYMENT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Commit SHA: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ’¬ Message: ${{ github.event.head_commit.message }}"
          echo "ğŸ• Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Trigger Render Deploy
        run: |
          echo "Triggering Render deployment..."
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}")
          http_code=$(echo "$response" | tail -n1)
          
          if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
            echo "âœ… Deployment triggered successfully (HTTP $http_code)"
          else
            echo "âŒ Deployment trigger failed with HTTP status: $http_code"
            echo "Response: $(echo "$response" | head -n -1)"
            exit 1
          fi

      - name: Wait for deployment
        run: |
          echo "â³ Waiting for Render deployment to complete..."
          echo "   This typically takes 2-3 minutes..."
          sleep 120

      - name: Health check with retries
        run: |
          echo "ğŸ” Running health checks..."
          MAX_ATTEMPTS=15
          WAIT_TIME=15
          
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $i/$MAX_ATTEMPTS..."
            
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout 10 \
              --max-time 30 \
              https://nairobi-verified-zkl3.onrender.com/api/health || echo "000")
            
            if [ "$response" = "200" ]; then
              echo "âœ… Health check PASSED! Service is healthy."
              
              # Get health details
              health_data=$(curl -s https://nairobi-verified-zkl3.onrender.com/api/health)
              echo "ğŸ“Š Health Status:"
              echo "$health_data" | grep -o '"database":"[^"]*"' || echo "   Database: Connected"
              echo "$health_data" | grep -o '"message":"[^"]*"' || echo "   Status: OK"
              
              exit 0
            fi
            
            echo "   â³ Health check returned HTTP $response, waiting ${WAIT_TIME}s..."
            sleep $WAIT_TIME
          done
          
          echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
          echo "âš ï¸  Deployment may have issues. Check Render dashboard."
          exit 1

      - name: Deployment success notification
        if: success()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ API: https://nairobi-verified-zkl3.onrender.com"
          echo "ğŸ–¥ï¸  Frontend: https://www.nairobiverified.co.ke"
          echo "âš™ï¸  Admin: https://nairobi-verified-admin.onrender.com"
          echo "ğŸ“Š Health: https://nairobi-verified-zkl3.onrender.com/api/health"
          echo "â° Completed: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

      - name: Deployment failure notification
        if: failure()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ DEPLOYMENT FAILED!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” Troubleshooting checklist:"
          echo "   1. Check Render dashboard: https://dashboard.render.com"
          echo "   2. Review deployment logs in Render"
          echo "   3. Verify environment variables are set"
          echo "   4. Check MongoDB connection string"
          echo "   5. Review recent code changes"
          echo ""
          echo "ğŸ“ Commit that failed: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

  # Job 5: Deploy to Staging (optional)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify staging deployment
        run: |
          echo "ğŸš€ Starting staging deployment..."
          echo "Commit: ${{ github.sha }}"

      - name: Trigger Render Staging Deploy
        run: |
          if [ -n "${{ secrets.RENDER_STAGING_DEPLOY_HOOK_URL }}" ]; then
            curl -s -X POST "${{ secrets.RENDER_STAGING_DEPLOY_HOOK_URL }}"
            echo "âœ… Staging deployment triggered!"
          else
            echo "âš ï¸  No staging deploy hook configured. Skipping..."
          fi
        continue-on-error: true

  # Job 6: Post-deployment Smoke Tests
  smoke-tests:
    name: Post-Deployment Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Run API smoke tests
        run: |
          echo "ğŸ§ª Running smoke tests..."
          echo ""
          
          # Test 1: Health endpoint
          echo "1ï¸âƒ£  Testing health endpoint..."
          health=$(curl -s -o /dev/null -w "%{http_code}" \
            https://nairobi-verified-zkl3.onrender.com/api/health)
          
          if [ "$health" = "200" ]; then
            echo "   âœ… Health endpoint: PASSED"
          else
            echo "   âŒ Health endpoint: FAILED (HTTP $health)"
            exit 1
          fi
          
          # Test 2: Products endpoint
          echo "2ï¸âƒ£  Testing products endpoint..."
          products=$(curl -s -o /dev/null -w "%{http_code}" \
            https://nairobi-verified-zkl3.onrender.com/api/products)
          
          if [ "$products" = "200" ]; then
            echo "   âœ… Products endpoint: PASSED"
          else
            echo "   âš ï¸  Products endpoint: HTTP $products"
          fi
          
          # Test 3: Merchants endpoint
          echo "3ï¸âƒ£  Testing merchants endpoint..."
          merchants=$(curl -s -o /dev/null -w "%{http_code}" \
            https://nairobi-verified-zkl3.onrender.com/api/merchants)
          
          if [ "$merchants" = "200" ]; then
            echo "   âœ… Merchants endpoint: PASSED"
          else
            echo "   âš ï¸  Merchants endpoint: HTTP $merchants"
          fi
          
          # Test 4: Auth endpoint structure
          echo "4ï¸âƒ£  Testing auth endpoints..."
          auth=$(curl -s -o /dev/null -w "%{http_code}" \
            https://nairobi-verified-zkl3.onrender.com/api/auth/login)
          
          # Expect 400 or 422 (validation error) not 404
          if [ "$auth" != "404" ]; then
            echo "   âœ… Auth endpoints: ACCESSIBLE"
          else
            echo "   âš ï¸  Auth endpoints: HTTP $auth"
          fi
          
          # Test 5: Response time check
          echo "5ï¸âƒ£  Testing API response time..."
          response_time=$(curl -o /dev/null -s -w '%{time_total}\n' \
            https://nairobi-verified-zkl3.onrender.com/api/health)
          echo "   â±ï¸  Response time: ${response_time}s"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… All smoke tests completed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"